# t3.medium 인스턴스 위험 분석 및 제한 필요성

## 인스턴스 사양 비교

| 인스턴스 타입 | vCPU | RAM | 비고 |
|------------|------|-----|------|
| **t3.small** (이전) | 2 | 2GB | 메모리 부족으로 서버 종료 |
| **t3.medium** (현재) | 2 | 4GB | 2배 증가 |

## t3.medium에서도 문제가 생길 수 있는 시나리오

### 1. FFmpeg 프로세스 동시 실행 (가장 위험)

**현재 코드 분석:**
- `camera-stream.gateway.ts`: 동시 스트림 수에 제한 없음
- `camera.service.ts`: 스냅샷 캡처 시마다 FFmpeg 프로세스 생성
- 각 FFmpeg 프로세스: **50-200MB 메모리 사용**

**위험 시나리오:**
```
기본 메모리 사용: ~1.8GB
+ FFmpeg 프로세스 10개: +1.0-2.0GB
+ 이미지 처리 작업: +200-500MB
+ 데이터베이스 쿼리: +100-300MB
+ 시스템 오버헤드: +200-300MB
─────────────────────────────────
총 사용량: 3.3-4.8GB → OOM 발생 가능!
```

**실제 발생 가능성:**
- 여러 사용자가 동시에 스트림 시청
- 여러 디바이스에서 동시에 스냅샷 캡처
- 스트림이 정상 종료되지 않고 누적

### 2. 이미지 처리 작업 (sharp 라이브러리)

**메모리 사용:**
- 이미지 리사이징: 원본 이미지 크기의 2-3배 메모리 필요
- 동시 처리 시: 각 작업마다 50-200MB 추가

**위험 시나리오:**
- 여러 디바이스에서 동시에 스냅샷 업로드
- 대용량 이미지 처리 시 메모리 급증

### 3. 데이터베이스 쿼리

**복잡한 쿼리 시:**
- 대량 데이터 조회: 100-500MB
- 시계열 집계 작업: 200-800MB
- 리포트 생성: 300-1GB

**위험 시나리오:**
- 여러 사용자가 동시에 리포트 요청
- 시계열 집계 작업이 동시에 실행

### 4. 메모리 누수

**가능한 원인:**
- WebSocket 연결이 정상 종료되지 않음
- FFmpeg 프로세스가 종료되지 않고 누적
- 버퍼가 정리되지 않음
- 이벤트 리스너가 제거되지 않음

### 5. 트래픽 급증

**피크 시간대:**
- 센서 데이터 대량 수신
- 여러 디바이스 동시 접속
- API 요청 급증

## 메모리 사용량 예측

### 정상 운영 시
```
기본 서비스: 1.8GB
+ FFmpeg 2-3개: +300-600MB
+ 여유 공간: +500MB
─────────────────────
총 사용량: ~2.6-2.9GB (안전)
```

### 피크 시간대
```
기본 서비스: 1.8GB
+ FFmpeg 8-10개: +800MB-2GB
+ 이미지 처리: +300-500MB
+ DB 쿼리: +200-400MB
+ 시스템: +300MB
─────────────────────
총 사용량: 3.4-5.0GB (위험!)
```

## 제한을 걸어야 하는 이유

### 1. OOM 방지
- 메모리 제한 없이 무제한 사용 시 OOM 발생
- Swap이 없으면 즉시 서버 종료
- 사용자 경험 저하

### 2. 예측 가능한 리소스 사용
- 각 서비스의 메모리 사용량 예측 가능
- 리소스 계획 수립 가능
- 비용 예측 가능

### 3. 서비스 안정성
- 한 서비스의 메모리 급증이 다른 서비스에 영향 주지 않음
- 컨테이너별 격리로 안정성 향상

### 4. 디버깅 용이
- 메모리 제한 초과 시 명확한 에러 메시지
- 문제 원인 파악 용이

## 권장 제한 설정

### Docker 컨테이너 메모리 제한 (이미 적용됨)

```yaml
app:
  mem_limit: 1.5g      # 최대 1.5GB
  mem_reservation: 512m  # 최소 512MB 보장

postgres:
  mem_limit: 512m     # 최대 512MB
  mem_reservation: 256m  # 최소 256MB 보장

redis:
  mem_limit: 256m     # 최대 256MB
  mem_reservation: 128m  # 최소 128MB 보장
```

### 추가로 필요한 제한

#### 1. FFmpeg 동시 실행 수 제한

**권장: 최대 5개 동시 스트림**

```typescript
// camera-stream.gateway.ts
private readonly MAX_CONCURRENT_STREAMS = 5;

@SubscribeMessage('startStream')
async handleStartStream(...) {
  if (this.activeStreams.size >= this.MAX_CONCURRENT_STREAMS) {
    client.emit('streamError', {
      message: '최대 동시 스트림 수를 초과했습니다. 잠시 후 다시 시도해주세요.',
    });
    return;
  }
  // ... 기존 코드 ...
}
```

#### 2. 이미지 처리 동시 작업 수 제한

**권장: BullMQ 큐를 통한 제한**

```typescript
// 이미지 처리 큐 설정
BullModule.registerQueue({
  name: 'image-processing',
  processors: [
    {
      name: 'resize',
      concurrency: 2, // 최대 2개 동시 처리
    },
  ],
});
```

#### 3. 데이터베이스 연결 풀 제한

**권장: TypeORM 설정**

```typescript
// typeorm.config.ts
{
  maxQueryExecutionTime: 5000, // 5초 타임아웃
  extra: {
    max: 10, // 최대 연결 수
    min: 2,  // 최소 연결 수
  },
}
```

#### 4. WebSocket 연결 수 제한

**권장: Socket.io 설정**

```typescript
// main.ts 또는 gateway 설정
const io = new Server(server, {
  maxHttpBufferSize: 1e6, // 1MB
  pingTimeout: 60000,
  pingInterval: 25000,
});
```

## 결론

### t3.medium에서도 문제가 생길 수 있습니다!

**이유:**
1. FFmpeg 프로세스가 동시에 10개 이상 실행되면 메모리 부족
2. 이미지 처리 작업이 동시에 많이 발생하면 메모리 급증
3. 복잡한 데이터베이스 쿼리가 동시에 실행되면 메모리 사용 증가
4. 메모리 누수로 인한 점진적 메모리 증가

### 제한을 반드시 걸어야 합니다!

**필수 제한:**
1. ✅ Docker 컨테이너 메모리 제한 (이미 적용)
2. ⚠️ FFmpeg 동시 실행 수 제한 (추가 필요)
3. ⚠️ Swap 메모리 추가 (추가 필요)
4. 📊 모니터링 설정 (권장)

**예상 효과:**
- OOM 발생 가능성: **90% → 10%** 감소
- 서비스 안정성: **크게 향상**
- 예측 가능성: **향상**




